+++
title = "Neovim Plugin Testing with Mocks: Customizing Child Neovim Instances in lazydocker.nvim"
date = "2025-09-17"
+++

Testing Neovim plugins is tricky: side effects like spawning jobs (_lazydocker_),
creating windows, notifications, etc.

In _lazydocker.nvim_ tests, we use a mock system to:

- Simulate missing executables (_docker_, _podman_, _lazydocker_)
- Capture _jobstart_ params (cmd, env)
- Stub window APIs (_nvim_win_is_valid_, _nvim_open_win_)
- Intercept _vim.notify_ for error verification

Powered by [mini.test](https://github.com/echasnovski/mini.nvim#mini.test) child Neovim instances.

# Child Neovim: Isolated Sandboxes

Bootstrap:

```lua
local child = helpers.new_child_neovim()  -- MiniTest child
child.setup()  -- Minimal init: readonly=false, small viewport (15x40)
child.load_lzd(config)  -- require('lazydocker').setup(config)
child.unload_lzd()  -- Cleanup: package.loaded, globals, augroups
```

Lifecycle management:

```lua
hooks = {
  pre_case = child.setup,
  post_case = child.unload_lzd,
  post_once = child.stop,
}
```

# Mock Factory System

_tests/mocks.lua_ exports _Mocks_ table with factories:

```lua
local Mocks = {}
Mocks.apply = function(mocks) for _, m in ipairs(mocks) do m.apply() end end
Mocks.restore = function(mocks) ... end  -- Batch apply/restore
```

**Executable Mocks** (simulate PATH):

```lua
Mocks.vim_fn_executable_no_docker = function(child)
  return create_executable_mock(child, "cmd == 'docker' and 0 or 1")
end
-- Overrides: vim.fn.executable(cmd) â†’ 0 for docker, 1 otherwise
```

**Jobstart Capture**:

```lua
Mocks.vim_fn_jobstart(child)  -- Logs: _G.mock_logs.jobstart = {cmd='lazydocker', env?, on_exit=fn}
-- Returns fake job ID 99
```

**Notify Spy**:

```lua
Mocks.vim_fn_notify(child)  -- _G.notify_messages = [{msg=..., level=ERROR}]
```

# Real Test Examples:

**Missing Docker**:

```lua
local Mocks = { mocks.vim_fn_executable_no_docker(child), mocks.vim_fn_notify(child) }
mocks.apply(Mocks)
lua("LazyDocker.open({ engine = 'docker' })")
eq(#get('_G.notify_messages'), 1)
eq(get('_G.notify_messages')[1].msg, 'LazyDocker: "docker" command not found...')
mocks.restore(Mocks)
```
